<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Finger+Paint&family=Roboto:wght@100&display=swap" rel="stylesheet">
        <link href="/fonts/meslo.ttf" rel="stylesheet">
        <title>DiceCTF 2024 - Funnylogin</title>        
    <link rel="stylesheet" href="/assets/404.b2188d1d.css" /></head>

    <body class="
        bg-[#3a3e4a]
        font-meslo
        pb-5

        flex
        flex-col

        pt-[2vh]
        pr-[25vh]
        pl-[25vh]
        gap-5
    ">
      <div class="
        flex 
        flex-row 
        truncate
        gap-5
      ">
        <div class="
          flex
          border-dashed
          border-2
          border-gray-500
          rounded-lg
        ">
          <div class="
	bg-[#464b59]
	rounded-lg
	text-white
	p-5
">
	<div class="
    p-4
    font-bold
    text-3xl
    text-center
    hover:animate-waving-hand
">
    <button onclick="
        (document.referrer.includes(document.location.host)
        && document.location.origin + '/' == document.referer
        )
        ? window.history.back()
        : window.location.href = '/'
    ">ðŸ‘ˆ</button>
</div>
</div>
        </div>
        <div class="
          rounded-lg
          shrink grow
          border-dashed
          border-2
          border-gray-500
        ">
          <div class="
	bg-[#464b59]
	rounded-lg
	text-white
	p-5
">
	<div class="
	p-2
	font-navpost
	text-center
  text-yellow-300
	text-3xl
">
	<a href="dicectf-2024-funnylogin">
		DiceCTF 2024 - Funnylogin
	</a>
</div>

<p class="
	font-sans
	text-center
  text-gray-300
	italic 
	hover:not-italic">
	Reading time: 3 minutes
</p>
</div>
        </div>
      </div>

    <div class="
      bg-[#434854]
      rounded-lg
      text-gray-300
      tracking-wider
      px-8

      cursor-auto

      border-dashed
      border-2
      border-gray-500
      
      min-w-full
      static
      gap-1
      leading-7

      prose
      prose-headings:text-yellow-400
      prose-em:text-yellow-400

      prose-a:text-yellow-400 
      hover:prose-a:text-yellow-600
      prose-a:cursor-pointer

      prose-code:text-yellow-400
      prose-code:before:content-['']
      prose-code:after:content-['']

      prose-strong:text-yellow-400
      
      prose-img:rounded-xl
      prose-img:min-w-full

      prose-img:outline
      prose-img:outline-offset-2 
      prose-img:outline-4

      prose-pre:outline
      prose-pre:outline-offset-2 
      prose-pre:outline-4

      text-lg
      text-justify
      prose-h1:before:content-['#_']
      prose-h2:before:content-['#_']
      prose-h3:before:content-['#_']
      prose-h4:before:content-['#_']
      prose-h5:before:content-['#_']
      
      prose-h1:text-2xl
      prose-h2:text-xl
      prose-h3:text-xl
      prose-h4:text-xl
      prose-h5:text-xl
      
      prose-h1:leading-8
      prose-h2:leading-8
      prose-h3:leading-8
      prose-h4:leading-8
      prose-h5:leading-8
      
      prose-h1:font-navpost
      prose-h2:font-navpost
      prose-h3:font-navpost
      prose-h4:font-navpost
      prose-h5:font-navpost

      list-inside
      marker:text-yellow-400
    " id="post">
      <div class="
          prose-img:border-4
          prose-img:border-gray-500
        ">
          <img src="/images/dicectf-2024-funnylogin.png">
        </div>
      <h2 id="introduction">Introduction</h2>
<p>This write-up aims to describe a possible solution to <code>Funnylogin</code> challenge of <a href="https://ctf.dicega.ng/" target="_blank" rel="noopener noreferrer">DiceCTF</a>, which is a web challenge.</p>
<h2 id="reconnaissance">Reconnaissance</h2>
<p>The application is just a login page. The challenge goal is to get the flag once a valid user is logged in with <code>admin</code> permission.</p>
<p>The users are randomly created as follows:</p>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #66D9EF">const</span><span style="color: #F8F8F2"> users </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> [</span><span style="color: #F92672">...</span><span style="color: #A6E22E">Array</span><span style="color: #F8F8F2">(</span><span style="color: #AE81FF">100_000</span><span style="color: #F8F8F2">)].</span><span style="color: #A6E22E">map</span><span style="color: #F8F8F2">(() </span><span style="color: #66D9EF">=></span><span style="color: #F8F8F2"> ({ user: </span><span style="color: #E6DB74">`user-</span><span style="color: #F92672">${</span><span style="color: #F8F8F2">crypto.</span><span style="color: #A6E22E">randomUUID</span><span style="color: #F8F8F2">()</span><span style="color: #F92672">}</span><span style="color: #E6DB74">`</span><span style="color: #F8F8F2">, pass: crypto.</span><span style="color: #A6E22E">randomBytes</span><span style="color: #F8F8F2">(</span><span style="color: #AE81FF">8</span><span style="color: #F8F8F2">).</span><span style="color: #A6E22E">toString</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">"hex"</span><span style="color: #F8F8F2">) }));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">db.</span><span style="color: #A6E22E">exec</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">`INSERT INTO users (id, username, password) VALUES </span><span style="color: #F92672">${</span><span style="color: #F8F8F2">users.</span><span style="color: #A6E22E">map</span><span style="color: #F8F8F2">((</span><span style="color: #FD971F">u</span><span style="color: #F8F8F2">,</span><span style="color: #FD971F">i</span><span style="color: #F8F8F2">) </span><span style="color: #66D9EF">=></span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">`(</span><span style="color: #F92672">${</span><span style="color: #F8F8F2">i</span><span style="color: #F92672">}</span><span style="color: #E6DB74">, '</span><span style="color: #F92672">${</span><span style="color: #F8F8F2">u.user</span><span style="color: #F92672">}</span><span style="color: #E6DB74">', '</span><span style="color: #F92672">${</span><span style="color: #F8F8F2">u.pass</span><span style="color: #F92672">}</span><span style="color: #E6DB74">')`</span><span style="color: #F8F8F2">).</span><span style="color: #A6E22E">join</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">", "</span><span style="color: #F8F8F2">)</span><span style="color: #F92672">}</span><span style="color: #E6DB74">`</span><span style="color: #F8F8F2">);</span></span></code></pre>
<p>The admin user is randomly defined at runtime, such as:</p>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #66D9EF">const</span><span style="color: #F8F8F2"> isAdmin </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> {};</span></span>
<span class="line"><span style="color: #66D9EF">const</span><span style="color: #F8F8F2"> newAdmin </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> users[Math.</span><span style="color: #A6E22E">floor</span><span style="color: #F8F8F2">(Math.</span><span style="color: #A6E22E">random</span><span style="color: #F8F8F2">() </span><span style="color: #F92672">*</span><span style="color: #F8F8F2"> users.length)];</span></span>
<span class="line"><span style="color: #F8F8F2">isAdmin[newAdmin.user] </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">true</span><span style="color: #F8F8F2">;</span></span></code></pre>
<p>The login SQL is defined as:</p>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #66D9EF">const</span><span style="color: #F8F8F2"> { user, pass } </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> req.body;</span></span>
<span class="line"><span style="color: #66D9EF">const</span><span style="color: #F8F8F2"> query </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">`SELECT id FROM users WHERE username = '</span><span style="color: #F92672">${</span><span style="color: #F8F8F2">user</span><span style="color: #F92672">}</span><span style="color: #E6DB74">' AND password = '</span><span style="color: #F92672">${</span><span style="color: #F8F8F2">pass</span><span style="color: #F92672">}</span><span style="color: #E6DB74">';`</span><span style="color: #F8F8F2">;</span></span></code></pre>
<p>The query is vulnerable to SQL injection due to the concatenation of <code>user</code> and <code>pass</code> constants from the request body.</p>
<p>The <code>flag</code> can be obtained by respecting the following restrictions:</p>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #66D9EF">const</span><span style="color: #F8F8F2"> FLAG </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> process.env.FLAG </span><span style="color: #F92672">||</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">"dice{test_flag}"</span><span style="color: #F8F8F2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #66D9EF">const</span><span style="color: #F8F8F2"> id </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> db.</span><span style="color: #A6E22E">prepare</span><span style="color: #F8F8F2">(query).</span><span style="color: #A6E22E">get</span><span style="color: #F8F8F2">()?.id;</span></span>
<span class="line"><span style="color: #F92672">if</span><span style="color: #F8F8F2"> (</span><span style="color: #F92672">!</span><span style="color: #F8F8F2">id) {</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> res.</span><span style="color: #A6E22E">redirect</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">"/?message=Incorrect username or password"</span><span style="color: #F8F8F2">);</span></span>
<span class="line"><span style="color: #F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F92672">if</span><span style="color: #F8F8F2"> (users[id] </span><span style="color: #F92672">&#x26;&#x26;</span><span style="color: #F8F8F2"> isadmin[user]) {</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> res.</span><span style="color: #A6E22E">redirect</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">"/?flag="</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">encodeURIComponent</span><span style="color: #F8F8F2">(FLAG));</span></span>
<span class="line"><span style="color: #F8F8F2">}</span></span>
<span class="line"></span></code></pre>
<p>In summary, the restrictions are:</p>
<ol>
<li>The user credential provided should return an <code>id</code>;</li>
<li>It should exist a user based on the <code>id</code>;</li>
<li>The user should have <code>admin</code> permission.</li>
</ol>
<p>As the application is vulnerable to <code>SQL injection</code>, it is possible to list all users of the application, but the <code>admin</code> is defined at runtime.
Therefore, a possible solution is brute forcing all users based on the <code>id</code> to figure out who is the <code>admin</code> to get the flag. The brute force attempts are up to 100000 users.</p>
<p>Payload to use in the <code>user</code> parameter to return the <code>id</code> 1:</p>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #F8F8F2">' OR id = '1</span></span></code></pre>
<p>As brute force is not allowed, it requires another exploit.</p>
<h2 id="exploit">Exploit</h2>
<p>The exploit is based on the bypass of all restrictions listed in the <code>recon</code> section.</p>
<p>The restriction 1 can be bypassed by providing a SQL query that returns any <code>id</code> in the database. A simple way is to use the following query:</p>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #F8F8F2">SELECT 1 as id;</span></span></code></pre>
<p>Using the SQL injection, it is possible to use <code>UNION</code> statement to include this <code>select</code>.</p>
<p>Payload to use with the <code>id</code> equal to 1:</p>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #F8F8F2">' UNION SELECT 1 as id;/*</span></span></code></pre>
<p>Note the <code>/*</code> is used to comment the rest of the query. The final SQL query using <code>pass</code> post HTTP parameter is:</p>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #F8F8F2">SELECT id FROM users WHERE username = '' AND password = '' UNION SELECT 1 as id;/*';</span></span></code></pre>
<p>To bypass the restriction 2, the <code>id</code> should be from 1 to 100000.</p>
<p>Finally, restriction 3 can be bypassed using JavaScript prototype inheritance <a href="#references">[1]</a>.</p>
<p>The admin verification uses the code <code>isadmin[user]</code>. For example, if the user <code>EffectRenan</code> is not the admin, <code>isadmin['EffectRenan']</code> will return <code>undefined</code>.</p>
<p>As JavaScript is based on prototypes, if the content of the <code>user</code> is not a valid property in the object and there is a valid property in the prototype, it returns the content from the prototype. The prototype of an object has the following default properties:</p>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #F92672">></span><span style="color: #F8F8F2"> obj </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> {}</span></span>
<span class="line"><span style="color: #F92672">></span><span style="color: #F8F8F2"> obj.</span></span>
<span class="line"><span style="color: #F8F8F2">obj.__proto__             obj.constructor           obj.hasOwnProperty</span></span>
<span class="line"><span style="color: #F8F8F2">obj.isPrototypeOf         obj.propertyIsEnumerable  obj.toLocaleString</span></span>
<span class="line"><span style="color: #F8F8F2">obj.toString              obj.valueOf</span></span></code></pre>
<p>Thus, if the <code>user</code> is <code>toString</code>, the check <code>isadmin[user]</code> will return <code>true</code>, bypassing the restriction 3.</p>
<p>Note that restrictions 1 and 2 are bypassed using <code>pass</code> parameter, as the information comes from the SQL query. Restriction 3 is bypassed using the <code>user</code> parameter.</p>
<p>To get the flag, make a post HTTP request to <code>https://funnylogin.mc.ax/api/login</code> with the following parameters:</p>
<ul>
<li>user: <code>toString</code></li>
<li>pass: <code>' UNION SELECT 1 as id;/*</code></li>
</ul>
<p><strong>Flag</strong>: <code>dice{i_l0ve_java5cript!}</code></p>
<h2 id="proof-of-concept">Proof of Concept</h2>
<iframe class="w-full" height="260px" src="https://flems.io/#0=N4IgzgpgNhDGAuEAmIBcICWA7JEAeAdABbwC2UIANCLAPZZi0xo1NQCGADpCtQGYYYYNAG1QWdqQgtsuQiXJVWWRCpYAePrQBOpAATsEGegF4AOiBLxuqAPS2+AVyxYAnlFoBzbAVKwC7Hi2XBi2Ht5YFnpS8ES0SOYgAAoA8gDKACoWAHxmWHp66ticjvB6ElKJjpDaUQBu7FCOEInwtGnw2tieUWZmufmFxaXlki0WnOxgYPWNzYkA5HoAqgByAJIpq3ppAKIAMrsAwhl6AIwGYHoYSADctgBUvf15BUVYJWXwrpzj4I4AI1IGHgsyafzSgOBoJAej6A3UDh0pGySkgMCM9GE6AAzKgcQA2EAAX0o4jGLC4nAIACthNQ6CoIGp0CSySAKtJ0GBvjACLBpkpGap4CwSQBdYlAA"></iframe>
<h2 id="references">References</h2>
<ol>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Inheritance_and_the_prototype_chain" target="_blank" rel="noopener noreferrer">JavaScript prototype inheritance</a>.</li>
<li><a href="https://ctf.dicega.ng/" target="_blank" rel="noopener noreferrer">DiceCTF</a></li>
</ol> 
    </div>
  </body></html>